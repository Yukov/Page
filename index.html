<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Claim Virtuals Tokens</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f2f4f8;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: white;
      padding: 30px 40px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      width: 100%;
    }
    h2 {
      text-align: center;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px 16px;
      margin-right: 10px;
      border: none;
      border-radius: 8px;
      background-color: #3b82f6;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    .status {
      margin-top: 16px;
      background: #eef;
      padding: 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Claim Virtuals TGE Token</h2>

    <label>
      Contract address:
      <input type="text" id="contractInput" value="0x285B95Fe51B9B7c5a5Da729Ac80E7FD1e9b72C4D">
    </label>

    <button id="connectBtn">üîå Connect Wallet</button>
    <button id="claimBtn" disabled>Claim Tokens</button>

    <div class="status">
      <div><strong>Wallet:</strong> <span id="walletAddress">‚Äì</span></div>
      <div><strong>Status:</strong> <span id="status">Waiting‚Ä¶</span></div>
    </div>
  </div>

  <script>
    const chainIdBase = "0x2105";
    const abi = [
      {
        "name": "claimAgentToken",
        "type": "function",
        "inputs":[{"name":"userAddress","type":"address"}],
        "outputs": [],
        "stateMutability": "nonpayable"
      }
    ];

    let provider, signer, userAddress, contract;
    let web3Modal;
    let checkerInterval = null;

    const contractInput = document.getElementById("contractInput");
    const connectBtn = document.getElementById("connectBtn");
    const claimBtn = document.getElementById("claimBtn");
    const walletEl = document.getElementById("walletAddress");
    const statusEl = document.getElementById("status");

    async function switchToBaseNet(provider) {
      try {
        await provider.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: chainIdBase }]
        });
      } catch (e) {
        if (e.code === 4902) {
          await provider.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: chainIdBase,
              chainName: 'Base',
              rpcUrls: ['https://mainnet.base.org'],
              nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
              blockExplorerUrls: ['https://basescan.org']
            }]
          });
        }
      }
    }

    async function checkEligibility() {
      if (!contract || !userAddress) return;

      try {
        claimBtn.disabled = true;
        statusEl.textContent = "Checking eligibility...";
        await contract.callStatic.claimAgentToken(userAddress);
        statusEl.textContent = "‚úÖ Tokens available to claim";
        claimBtn.disabled = false;
      } catch(err) {
        statusEl.textContent = "‚ö†Ô∏è " + (err.reason || err.message);
        claimBtn.disabled = true;
      }
    }

    async function initWallet() {
      const providerOptions = {
        walletconnect: {
          package: window.WalletConnectProvider.default,
          options: {
            rpc: {
              8453: "https://mainnet.base.org" // Base Mainnet
            }
          }
        }
      };

      web3Modal = new window.Web3Modal.default({
        cacheProvider: false,
        providerOptions
      });

      const instance = await web3Modal.connect();
      provider = new window.ethers.providers.Web3Provider(instance);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      walletEl.textContent = userAddress;

      await switchToBaseNet(instance);

      const address = contractInput.value.trim();
      if (!window.ethers.utils.isAddress(address)) {
        statusEl.textContent = "‚ùå Invalid contract address";
        return;
      }

      contract = new window.ethers.Contract(address, abi, signer);

      await checkEligibility();
      if (checkerInterval) clearInterval(checkerInterval);
      checkerInterval = setInterval(checkEligibility, 5000);

      claimBtn.onclick = async () => {
        try {
          statusEl.textContent = "üì§ Sending transaction...";
          const tx = await contract.claimAgentToken(userAddress);
          statusEl.innerHTML = `‚úÖ Tx sent: <a href="https://basescan.org/tx/${tx.hash}" target="_blank">${tx.hash}</a>`;
          claimBtn.disabled = true;
        } catch(err) {
          statusEl.textContent = "‚ùå Tx error: " + (err.reason || err.message);
        }
      };
    }

    connectBtn.onclick = initWallet;
  </script>
</body>
</html>
